
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>23-6 Flashcards</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; padding: 2rem; }
        .card-link { margin-bottom: 1rem; }
        .flash { margin-bottom: 20px; }
        .result { margin-top: 20px; font-weight: bold; }
    </style>
</head>
<body>

<button class="flash" onclick="window.location.href='flashcards.html'">‚¨ÖÔ∏è Back to Flashcards</button>
<div id='result' class='result'></div>
<script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
<script>
    const cards = [{"phrase": "Dzi\u0119kuj\u0119", "pronunciation": "jen-KOO-yeh", "meaning": "Thank you"}, {"phrase": "Przepraszam", "pronunciation": "psheh-PRAH-shahm", "meaning": "Sorry/Excuse me"}, {"phrase": "Prosz\u0119 powt\u00f3rzy\u0107!", "pronunciation": "PROH-sheh pohv-TOO-zheetch", "meaning": "Please repeat!"}, {"phrase": "Co to znaczy", "pronunciation": "tso toh ZNAH-chee", "meaning": "What does it mean?"}, {"phrase": "Tak", "pronunciation": "tahk", "meaning": "Yes"}, {"phrase": "Nie", "pronunciation": "nyeh", "meaning": "No"}, {"phrase": "Nie wiem", "pronunciation": "nyeh VYEM", "meaning": "I don't know"}, {"phrase": "Prosz\u0119 napisa\u0107!", "pronunciation": "PROH-sheh nah-PEE-sahtch", "meaning": "Please write it down!"}, {"phrase": "Gdzie jest toaleta", "pronunciation": "g-jeh yest toh-ah-LEH-tah", "meaning": "Where is the toilet?"}, {"phrase": "Prosz\u0119 m\u00f3wi\u0107 wolniej", "pronunciation": "PROH-sheh MOO-veech VOL-nyeh", "meaning": "Please speak more slowly"}, {"phrase": "Mam pytanie", "pronunciation": "mahm pih-TAH-nyeh", "meaning": "I have a question"}, {"phrase": "Nie rozumiem", "pronunciation": "nyeh roh-ZOO-myem", "meaning": "I don't understand"}];
    let index = 0;
    let tries = 0;
    let cachedSpeechConfig = null;

    function speak(text, lang, cb) {
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = lang;
        msg.onend = cb;
        speechSynthesis.speak(msg);
    }

    function playAudio(index, cb) {
        const phrase = cards[index].phrase;
        const filename = `${index}_${phrase.replace(/[^a-zA-Z0-9]/g, '_')}.mp3`;
        const audio = new Audio();
        const repo = window.location.pathname.split("/")[1];
        const basePath = window.location.hostname === "andrewdionne.github.io" ? `/${window.location.pathname.split("/")[1]}/` : "/";
        audio.src = `${basePath}static/${set_name}/audio/${filename}`;
        audio.onended = cb;
        audio.play();
    }

    async function getSpeechConfig() {
        if (cachedSpeechConfig) return cachedSpeechConfig;
        const res = await fetch("https://flashcards-5c95.onrender.com/api/token");
        const data = await res.json();
        const config = SpeechSDK.SpeechConfig.fromAuthorizationToken(data.token, data.region);
        config.speechRecognitionLanguage = "pl-PL";
        cachedSpeechConfig = config;
        return config;
    }

    async function assess(text) {
        const resultDiv = document.getElementById("result");
        const config = await getSpeechConfig();
        const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
        const recognizer = new SpeechSDK.SpeechRecognizer(config, audioConfig);
        const assessConfig = new SpeechSDK.PronunciationAssessmentConfig(text, SpeechSDK.PronunciationAssessmentGradingSystem.HundredMark, SpeechSDK.PronunciationAssessmentGranularity.FullText, false);
        assessConfig.applyTo(recognizer);

        return new Promise(resolve => {
            recognizer.recognized = (s, e) => {
                let score = 0;
                try {
                    const data = JSON.parse(e.result.json);
                    score = data.NBest[0].PronunciationAssessment.AccuracyScore;
                } catch {}
                recognizer.stopContinuousRecognitionAsync();
                resolve(score);
            };
            recognizer.startContinuousRecognitionAsync();
        });
    }

    async function run() {
        if (index >= cards.length) {
            document.getElementById("result").innerText = "üéâ Practice complete!";
            return;
        }
        const card = cards[index];
        speak(card.meaning, "en", () => {
            playAudio(index, async () => {
                const score = await assess(card.phrase);
                if (score >= 70 || tries >= 2) {
                    index++;
                    tries = 0;
                } else {
                    tries++;
                }
                run();
            });
        });
    }

    run();
</script>
</body>
</html>
